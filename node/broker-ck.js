var MongoClient=require("mongodb").MongoClient,mqtt=require("mqttjs"),port=1883,host="127.0.0.1",topic="presence",mqttServer,mqttClient,io=require("socket.io").listen(8080),userCollection,reset=!1,users=[{name:"Saul",presence:!1,id:"0800E3CE07"},{name:"Florian",presence:!1,id:"0800DE1994"},{name:"Ben",presence:!1,id:"0800DE1B47"},{name:"James",presence:!1,id:"0800E3CA33"}];MongoClient.connect("mongodb://localhost:27017/inhabit",function(e,t){if(!!e){console.log("Not connected.");return!1}console.log("Connected.");var n;userCollection=t.collection("users");userCollection.find().toArray(function(e,t){if(e===null){n=t;console.log("Getting users in users collection: ",t);if(n.length===0||reset===!0){userCollection.remove(function(e,t){e===null?console.log("Users collection emptied: ",t):console.log(e)});userCollection.insert(users,{safe:!0},function(e,t){e===null?console.log("Users added to collection: ",t):console.log("Users not added to collection: ",e)});userCollection.find().toArray(function(e,t){if(e===null){n=t;console.log("Getting users in users collection, post addition: ",t)}else console.log(e)})}}else console.log(e)})});mqttServer=mqtt.createServer(function(e){var t=this;t.clients||(t.clients={});e.on("connect",function(n){e.connack({returnCode:0});e.id=n.client;t.clients[e.id]=e;console.log("Client joined: ",n);e.id!=="nodeClient"&&mqttClient.publish({topic:topic,payload:"Hi, Arduino!"})});e.on("publish",function(e){for(var n in t.clients)t.clients[n].publish({topic:e.topic,payload:e.payload})});e.on("subscribe",function(t){var n=[];for(var r=0;r<t.subscriptions.length;r++)n.push(t.subscriptions[r].qos);e.suback({granted:n});console.log("Subscribe received: ",t)});e.on("pingreq",function(t){e.pingresp()});e.on("disconnect",function(t){e.stream.end()});e.on("close",function(n){delete t.clients[e.id]});e.on("error",function(t){e.stream.end();util.log("error!")})}).listen(port);mqttClient=mqtt.createClient(port,host,function(e,t){t.connect({client:"nodeClient"});t.on("connack",function(e){if(e.returnCode!==0){console.log("connack error %d",e.returnCode);process.exit(-1)}});t.on("publish",function(e){console.log("Payload received: ",e.topic,e.payload);e.topic===topic&&userCollection.find({id:e.payload}).toArray(function(e,t){if(e===null){console.log("Find items with id of payload: ",t);if(t.length>0){var n=t[0];n.presence=!n.presence;userCollection.update({name:n.name},{$set:{presence:n.presence}},{safe:!0},function(e,t){e===null?io.sockets.emit("presence",{user:n}):console.log(e)})}}else console.log(e)})});t.on("close",function(){process.exit(0)});t.on("error",function(e){console.log("error %s",e);process.exit(-1)})});setTimeout(function(){mqttClient.publish({topic:topic,payload:"0800E3CA33"})},1e3);io.sockets.on("connection",function(e){e.emit("message",{message:"Congrats, your penis fits in the socket!"})});