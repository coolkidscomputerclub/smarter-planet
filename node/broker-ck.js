var MongoClient=require("mongodb").MongoClient,mqtt=require("mqttjs"),port=1883,host="127.0.0.1",topic="presence",mqttServer,mqttClient,io=require("socket.io").listen(8080,{log:!1}),database,eventCollection,events,userCollection,users,reset=!1,_users=[{name:"Saul",preferences:{temperature:22},avatar:"img/avatar/saul.jpg",presence:!1,id:"0800E3CE07"},{name:"Florian",preferences:{temperature:26},avatar:"img/avatar/flo.jpg",presence:!1,id:"0800DE1994"},{name:"Ben",preferences:{temperature:20},avatar:"img/avatar/ben.jpg",presence:!1,id:"0800DE1B47"},{name:"James",preferences:{temperature:18},avatar:"img/avatar/james.jpg",presence:!1,id:"0800E3CA33"}],_events=[{type:"presence",user:{name:"Saul",preferences:{temperature:22},avatar:"img/avatar/saul.jpg",presence:!0,id:"0800E3CE07"},timestamp:new Date},{type:"presence",user:{name:"Saul",preferences:{temperature:22},avatar:"img/avatar/saul.jpg",presence:!1,id:"0800E3CE07"},timestamp:new Date},{type:"presence",user:{name:"Ben",preferences:{temperature:20},avatar:"img/avatar/ben.jpg",presence:!1,id:"0800DE1B47"},timestamp:new Date},{type:"presence",user:{name:"Ben",preferences:{temperature:20},avatar:"img/avatar/ben.jpg",presence:!0,id:"0800DE1B47"},timestamp:new Date}];MongoClient.connect("mongodb://localhost:27017/inhabit",function(e,t){if(!!e){console.log("Not connected.");return!1}console.log("Connected.");database=t;eventCollection=database.collection("events");eventCollection.find().toArray(function(e,t){if(e===null){events=t;console.log("Events in events collection: ",events);reset===!0?eventCollection.remove(function(e,t){e===null?console.log("Events collection emptied: ",t):console.log(e)}):events.length<1&&eventCollection.insert(_events,{safe:!0},function(e,t){e===null?console.log("Events added to collection: ",t):console.log("Events not added to collection: ",e)})}else console.log(e)});userCollection=database.collection("users");userCollection.find().toArray(function(e,t){if(e===null){users=t;console.log("Users in users collection: ",users);if(users.length===0||reset===!0){userCollection.remove(function(e,t){e===null?console.log("Users collection emptied: ",t):console.log(e)});userCollection.insert(_users,{safe:!0},function(e,t){e===null?console.log("Users added to collection: ",t):console.log("Users not added to collection: ",e)});userCollection.find().toArray(function(e,t){if(e===null){users=t;console.log("Getting users in users collection, post addition: ",t)}else console.log(e)})}}else console.log(e)})});mqttServer=mqtt.createServer(function(e){var t=this;t.clients||(t.clients={});e.on("connect",function(n){e.connack({returnCode:0});e.id=n.client;t.clients[e.id]=e;console.log("Client joined: ",e.id)});e.on("publish",function(n){for(var r in t.clients)r!==e.id&&t.clients[r].publish({topic:n.topic,payload:n.payload})});e.on("subscribe",function(t){var n=[];for(var r=0;r<t.subscriptions.length;r++)n.push(t.subscriptions[r].qos);e.suback({granted:n});console.log("Subscribe received: ",t)});e.on("pingreq",function(t){e.pingresp()});e.on("disconnect",function(t){e.stream.end()});e.on("close",function(n){delete t.clients[e.id]});e.on("error",function(t){e.stream.end();util.log("error!")})}).listen(port);mqttClient=mqtt.createClient(port,host,function(e,t){t.connect({client:"nodeClient"});t.on("connack",function(e){if(e.returnCode!==0){console.log("connack error %d",e.returnCode);process.exit(-1)}});t.on("publish",function(e){console.log("Payload received: ",e.topic,e.payload);e.topic===topic&&userCollection.find({id:e.payload}).toArray(function(e,t){if(e===null){if(t.length>0){var n=t[0];console.log("Setting "+n.name+"'s presence to: ",!n.presence);userCollection.update({name:n.name},{$set:{presence:!n.presence}},{safe:!0},function(e,t){e===null?userCollection.find({name:n.name}).toArray(function(e,t){if(e===null){if(t.length>0){var r=new Date;n=t[0];eventCollection.insert({type:"presence",user:n,timestamp:r},{safe:!0},function(e,t){e===null?console.log("Event logged: ",t):console.log(e)});io.sockets.emit("event",{type:"presence",user:n,timestamp:r});io.sockets.emit("presence",{user:n,timestamp:r})}}else console.log(e)}):console.log(e)})}}else console.log(e)})});t.on("close",function(){process.exit(0)});t.on("error",function(e){console.log("error %s",e);process.exit(-1)})});io.sockets.on("connection",function(e){var t=database.collection("events"),n,r=database.collection("users"),i;t.find().toArray(function(t,r){if(t===null){n=r;e.emit("events",{events:n})}else console.log(t)});r.find().toArray(function(t,n){if(t===null){i=n;e.emit("users",{users:i})}else console.log(t)});e.emit("message",{message:"Congrats, your penis fits in the socket!"})});