// Generated by CoffeeScript 1.3.3
(function() {
  var Inhabitant, config, currentLine, housemates, main, step;

  Inhabitant = (function() {

    function Inhabitant(index, id, name) {
      this.index = index;
      this.id = id;
      this.name = name;
      this.inactiveState = {
        "stroke-width": 4,
        stroke: "#ebebeb"
      };
      this.activeState = {
        "stroke-width": 8,
        stroke: "rgba(6,219,180, 1)"
      };
    }

    Inhabitant.prototype.draw = function() {
      this.avatar = window.paper.circle(135 + (this.index * 250), 95, 75).attr({
        fill: "url(images/" + this.id + ".jpg)"
      });
      this.avatar.click(function(e) {});
      if (!this.home) {
        this.avatar.attr(this.inactiveState);
      } else {
        this.avatar.attr(this.activeState);
      }
      this.label = window.paper.text(135 + (this.index * 250), 192, this.name).attr({
        "font-family": "Helvetica Neue",
        "font-size": 18,
        fill: "#999"
      });
      return this.status = window.paper.text(135 + (this.index * 250), 212, "is out and about").attr({
        "font-family": "Helvetica Neue",
        "font-size": 12,
        fill: "#648D8E"
      });
    };

    Inhabitant.prototype.setStatus = function(newStatus) {
      return this.status.attr({
        text: newStatus
      });
    };

    Inhabitant.prototype.setTempPreference = function(tempPreference) {
      this.tempPreference = tempPreference;
    };

    Inhabitant.prototype.isHome = function() {
      return this.home;
    };

    Inhabitant.prototype.setPresence = function(status) {
      this.home = status;
      if (this.home) {
        this.avatar.animate(this.activeState, 1000);
        return this.setStatus("is in");
      } else {
        this.avatar.animate(this.inactiveState, 1000);
        return this.setStatus("is out and about");
      }
    };

    Inhabitant.prototype.togglePresence = function() {
      this.home = this.home ? false : true;
      if (this.home) {
        this.avatar.animate(this.activeState, 1000);
        return this.setStatus("just got in");
      } else {
        this.avatar.animate(this.inactiveState, 1000);
        return this.setStatus("just left");
      }
    };

    return Inhabitant;

  })();

  step = function() {
    var date, hour, minutes;
    date = new Date();
    hour = date.getHours();
    minutes = date.getMinutes() * (2 / 3);
    window.nowBar.animate({
      x: 32 + (hour * 40) + minutes
    }, 300);
    return window.tempLine.animate({
      "path": "M32 500L" + (32 + (hour * 40) + minutes) + " 500"
    }, 300);
  };

  main = {
    init: function() {
      return this.connectSocket();
    },
    connectSocket: function() {
      this.socket = io.connect("//" + config.socketServer + ":8080");
      return this.bindSocketEvents();
    },
    bindSocketEvents: function() {
      this.socket.on("events", function(data) {});
      this.socket.on("users", function(data) {
        var user, _i, _len, _ref, _results;
        _ref = data.users;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          user = _ref[_i];
          housemates[user.id].setPresence(user.presence);
          _results.push(housemates[user.id].setTempPreference(user.preferences.temperature));
        }
        return _results;
      });
      return this.socket.on("event", function(data) {
        switch (data.type) {
          case "presence":
            return housemates[data.user.id].togglePresence();
        }
      });
    }
  };

  config = {
    socketServer: '192.168.0.2'
  };

  housemates = {
    saul: new Inhabitant(0, "saul", "Saul"),
    florian: new Inhabitant(1, "florian", "Florian"),
    ben: new Inhabitant(2, "ben", "Ben"),
    james: new Inhabitant(3, "james", "James")
  };

  currentLine = [];

  $(function() {
    var i, id, mate, _i;
    $(document).bind('touchmove', function(event) {
      return event.preventDefault();
    });
    window["paper"] = Raphael("mainCanvas", 1024, 768);
    for (id in housemates) {
      mate = housemates[id];
      mate.draw();
    }
    window["nowBar"] = paper.rect(32, 300, 3, 300).attr({
      fill: "#ebebeb",
      "stroke-width": 0,
      "fill-opacity": 0.6
    });
    for (i = _i = 0; _i <= 24; i = ++_i) {
      paper.text(32 + (i * 40), 560, i).attr({
        fill: "#648D8E",
        "font-size": 12
      });
    }
    window.paper.path("M32 500L352 500L352 420L472 420L472 500L792 500L792 380L952 380L952 500L992 500").attr({
      "stroke": "#999",
      "stroke-dasharray": "--"
    });
    window["tempLine"] = paper.path("M32 500L32 500").attr({
      "stroke": "rgba(235,155,101,1)",
      "stroke-width": 4
    });
    window["tempOutside"] = paper.text(32, 330, "10°C").attr({
      "font-family": "Helvetica Neue",
      "font-size": 32,
      "text-anchor": "start",
      "fill": "#999"
    });
    window["tempInside"] = paper.text(32, 370, "18°C").attr({
      "font-family": "Helvetica Neue",
      "font-size": 32,
      "text-anchor": "start",
      "fill": "#333"
    });
    step();
    setInterval(step, 60000);
    return main.init();
  });

}).call(this);
